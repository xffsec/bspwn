# Helper function to merge multiple HTML reports into one
_xmap_merge_html_reports() {
    local target_clean="$1"
    shift
    local html_files=("$@")
    
    # Create consolidated HTML
    cat > "targeted-${target_clean}.html" <<EOF
<!DOCTYPE html>
<html>
<head>
    <title>Consolidated Scan Report for ${target_clean}</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 5px 5px 0 0;
        }
        .protocol-section { 
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tcp { border-left: 5px solid #4CAF50; }
        .udp { border-left: 5px solid #2196F3; }
        .sctp { border-left: 5px solid #FF9800; }
        h1 { margin: 0; }
        h2 { 
            color: #333;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .timestamp { 
            color: #ecf0f1; 
            font-size: 0.9em;
            margin-top: 10px;
        }
        .protocol-content {
            margin-top: 15px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            text-align: left;
            padding: 8px;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Consolidated Scan Report</h1>
        <p class="timestamp">Generated on: $(date)</p>
        <p class="timestamp">Target: ${target_clean}</p>
    </div>
EOF
    
    # Extract and merge content from each HTML file
    for html_file in "${html_files[@]}"; do
        # Determine protocol from filename
        local protocol="unknown"
        local protocol_name="Unknown"
        if [[ "$html_file" == *"tcp-svc-"* ]]; then
            protocol="tcp"
            protocol_name="TCP"
        elif [[ "$html_file" == *"udp-svc-"* ]]; then
            protocol="udp"
            protocol_name="UDP"
        elif [[ "$html_file" == *"sctp-svc-"* ]]; then
            protocol="sctp"
            protocol_name="SCTP"
        fi
        
        cat >> "targeted-${target_clean}.html" <<EOF
    <div class="protocol-section ${protocol}">
        <h2>${protocol_name} Service Detection Results</h2>
        <div class="protocol-content">
EOF
        
        # Extract the body content from the nmap HTML (between <body> tags)
        # This preserves nmap's formatting and tables
        if [[ -f "$html_file" ]]; then
            sed -n '/<body>/,/<\/body>/p' "$html_file" | \
                grep -v '<body>' | \
                grep -v '</body>' | \
                sed 's/<h1>Nmap/<h3>Nmap/g' | \
                sed 's/<\/h1>/<\/h3>/g' >> "targeted-${target_clean}.html"
        fi
        
        cat >> "targeted-${target_clean}.html" <<EOF
        </div>
        <p style="color: #888; font-size: 0.85em; margin-top: 15px;">Source: $html_file</p>
    </div>
EOF
    done
    
    cat >> "targeted-${target_clean}.html" <<EOF
</body>
</html>
EOF
    
    echo "Consolidated HTML report generated: targeted-${target_clean}.html"
}

function xmap() {
    # Default values
    local target=""
    local scan_types="tcp,udp"
    local min_rate=5000
    local tcp_only=false
    local udp_only=false
    local sctp_scan=false
    local run_service_scan=true
    local generate_html=true
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -t|--tcp)
                tcp_only=true
                scan_types="tcp"
                shift
                ;;
            -u|--udp)
                udp_only=true
                scan_types="udp"
                shift
                ;;
            -s|--sctp)
                sctp_scan=true
                [[ "$scan_types" != "tcp" && "$scan_types" != "udp" ]] && scan_types="sctp"
                shift
                ;;
            -r|--range)
                if [[ -n "$2" && "$2" =~ ^[0-9]+$ ]]; then
                    min_rate="$2"
                    shift 2
                else
                    echo "Error: --range requires a numeric value"
                    return 1
                fi
                ;;
            --no-service|--no-svc)
                run_service_scan=false
                shift
                ;;
            --no-html)
                generate_html=false
                shift
                ;;
            --help|-h)
                echo "Usage: xmap <target> [options]"
                echo ""
                echo "Options:"
                echo "  -t, --tcp         TCP scan only"
                echo "  -u, --udp         UDP scan only"
                echo "  -s, --sctp        SCTP scan (along with other selected scans)"
                echo "  -r, --range N     Set minimum packet rate (default: 5000)"
                echo "  --no-service      Skip service detection (-sVC) scan"
                echo "  --no-html         Skip HTML report generation"
                echo "  -h, --help        Show this help message"
                echo ""
                echo "Examples:"
                echo "  xmap 192.168.1.1              # Full scan: TCP+UDP+Service+HTML"
                echo "  xmap 192.168.1.1 -t           # TCP only with service detection"
                echo "  xmap 192.168.1.1 -u --no-html # UDP only, no HTML report"
                echo "  xmap 192.168.1.1 --no-service # Skip service detection"
                return 0
                ;;
            -*)
                echo "Unknown option: $1"
                echo "Use --help for usage information"
                return 1
                ;;
            *)
                target="$1"
                shift
                ;;
        esac
    done
    
    # Validate target
    if [[ -z "$target" ]]; then
        echo "Error: Target IP/hostname is required"
        echo "Usage: xmap <target> [options]"
        return 1
    fi
    
    # Clean target for filename
    local target_clean="${target//\//_}"
    
    # Conflict resolution
    if [[ "$tcp_only" = true && "$udp_only" = true ]]; then
        echo "Warning: Both -t and -u specified, defaulting to both TCP and UDP"
        scan_types="tcp,udp"
    fi
    
    # Build scan types array
    local scan_array=()
    if [[ "$scan_types" == "tcp" ]]; then
        scan_array=("tcp")
    elif [[ "$scan_types" == "udp" ]]; then
        scan_array=("udp")
    elif [[ "$scan_types" == "tcp,udp" ]]; then
        scan_array=("tcp" "udp")
    fi
    
    # Add SCTP if requested
    if [[ "$sctp_scan" = true ]]; then
        scan_array+=("sctp")
    fi
    
    echo "Starting xmap scan for target: $target"
    echo "Scan types: ${scan_array[@]}"
    echo "Minimum rate: $min_rate packets/sec"
    echo "Service detection: $([ "$run_service_scan" = true ] && echo "Enabled" || echo "Disabled")"
    echo "HTML report: $([ "$generate_html" = true ] && echo "Enabled" || echo "Disabled")"
    echo ""
    
    # Execute initial scans
    for scan_type in "${scan_array[@]}"; do
        case $scan_type in
            tcp)
                echo "=== Starting TCP SYN scan (all ports) ==="
                sudo nmap -sS -p- --open -n -Pn --min-rate="$min_rate" --disable-arp-ping \
                    --stats-every=5s -oA "tcp-all-$target_clean" "$target"
                echo ""
                ;;
            udp)
                echo "=== Starting UDP scan (top 100 ports) ==="
                sudo nmap -sU -F --open -n -Pn --min-rate="$min_rate" --disable-arp-ping \
                    --stats-every=5s -oA "udp-all-$target_clean" "$target"
                echo ""
                ;;
            sctp)
                echo "=== Starting SCTP scan ==="
                sudo nmap -sY -p- --open -n -Pn --min-rate="$min_rate" --disable-arp-ping \
                    --stats-every=5s -oA "sctp-all-$target_clean" "$target"
                echo ""
                ;;
        esac
    done
    
    # Process results and run service detection if enabled
    if [[ "$run_service_scan" = true ]]; then
        echo "=== Processing results for service detection ==="
        
        # Extract target IP from first scan file
        local target_ip=""
        for scan_type in "${scan_array[@]}"; do
            local scan_file="${scan_type}-all-${target_clean}.nmap"
            if [[ -f "$scan_file" && -z "$target_ip" ]]; then
                target_ip=$(grep -oP '^Nmap scan report for \K[0-9.]+' "$scan_file" 2>/dev/null || \
                           grep -E -o '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' "$scan_file" | head -1)
                [[ -n "$target_ip" ]] && break
            fi
        done
        
        if [[ -z "$target_ip" ]]; then
            echo "Warning: Could not extract target IP"
            echo "Skipping service detection scan"
            run_service_scan=false
        else
            echo "Target IP: $target_ip"
            
            # Run service detection for each protocol separately
            local service_detection_files=()
            
            for scan_type in "${scan_array[@]}"; do
                local scan_file="${scan_type}-all-${target_clean}.nmap"
                
                if [[ -f "$scan_file" ]]; then
                    echo "Checking $scan_type ports..."
                    
                    # Extract open ports for this protocol
                    local scan_ports=$(grep -E '^[0-9]+/.*open' "$scan_file" | awk -F'/' '{print $1}' | xargs | tr " " "," 2>/dev/null)
                    
                    if [[ -n "$scan_ports" ]]; then
                        echo "Found $scan_type ports: $scan_ports"
                        
                        # Run appropriate service detection based on protocol
                        case $scan_type in
                            tcp)
                                echo "=== Running TCP service detection ==="
                                sudo nmap -sVC -p"$scan_ports" --disable-arp-ping --min-rate="$min_rate" \
                                    -n -Pn "$target_ip" --stats-every=5s -oA "tcp-svc-$target_clean"
                                service_detection_files+=("tcp-svc-${target_clean}.xml")
                                ;;
                            udp)
                                echo "=== Running UDP service detection ==="
                                sudo nmap -sUVC -p"$scan_ports" --disable-arp-ping --min-rate="$min_rate" \
                                    -n -Pn "$target_ip" --stats-every=5s -oA "udp-svc-$target_clean"
                                service_detection_files+=("udp-svc-${target_clean}.xml")
                                ;;
                            sctp)
                                echo "=== Running SCTP service detection ==="
                                sudo nmap -sY -sV -p"$scan_ports" --disable-arp-ping --min-rate="$min_rate" \
                                    -n -Pn "$target_ip" --stats-every=5s -oA "sctp-svc-$target_clean"
                                service_detection_files+=("sctp-svc-${target_clean}.xml")
                                ;;
                        esac
                        echo ""
                    else
                        echo "No open $scan_type ports found"
                    fi
                fi
            done
            
            # Generate consolidated HTML report if enabled and we have service detection files
            if [[ "$generate_html" = true && ${#service_detection_files[@]} -gt 0 ]]; then
                echo "=== Generating consolidated HTML report ==="
                
                # Check if xsltproc is available
                if command -v xsltproc >/dev/null; then
                    # Process each XML file with xsltproc and collect the HTML outputs
                    local html_files=()
                    
                    for xml_file in "${service_detection_files[@]}"; do
                        if [[ -f "$xml_file" ]]; then
                            local html_output="${xml_file%.xml}.html"
                            echo "Converting $xml_file to HTML..."
                            xsltproc -o "$html_output" "$xml_file"
                            
                            if [[ $? -eq 0 && -f "$html_output" ]]; then
                                html_files+=("$html_output")
                            else
                                echo "Warning: Failed to convert $xml_file"
                            fi
                        fi
                    done
                    
                    # Now merge all HTML files into a consolidated report
                    if [[ ${#html_files[@]} -gt 0 ]]; then
                        echo "Merging HTML reports..."
                        _xmap_merge_html_reports "$target_clean" "${html_files[@]}"
                    else
                        echo "Error: No HTML files were generated"
                    fi
                    
                    # Try to open in default browser
                    if [[ -f "targeted-${target_clean}.html" ]]; then
                        if [[ "$OSTYPE" == "darwin"* ]]; then
                            open "targeted-${target_clean}.html" 2>/dev/null &
                        elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
                            xdg-open "targeted-${target_clean}.html" 2>/dev/null &
                        fi
                    fi
                else
                    echo "Warning: xsltproc not installed, cannot generate HTML report"
                    echo "Install xsltproc with:"
                    echo "  Ubuntu/Debian: sudo apt-get install xsltproc"
                    echo "  macOS: brew install libxslt"
                    echo "  Fedora: sudo dnf install libxslt"
                fi
            fi
        fi
    fi
    
    echo "=== Scan Summary ==="
    echo ""
    
    # List all created files
    local created_files=()
    
    for scan_type in "${scan_array[@]}"; do
        for ext in ".nmap" ".gnmap" ".xml"; do
            local file="${scan_type}-all-${target_clean}${ext}"
            if [[ -f "$file" ]]; then
                created_files+=("$file")
            fi
        done
    done
    
    if [[ "$run_service_scan" = true ]]; then
        for scan_type in "${scan_array[@]}"; do
            for ext in ".nmap" ".gnmap" ".xml"; do
                local file="${scan_type}-svc-${target_clean}${ext}"
                if [[ -f "$file" ]]; then
                    created_files+=("$file")
                fi
            done
        done
        
        if [[ -f "targeted-${target_clean}.html" ]]; then
            created_files+=("targeted-${target_clean}.html")
        fi
    fi
    
    if [[ ${#created_files[@]} -gt 0 ]]; then
        echo "Created files:"
        for file in "${created_files[@]}"; do
            ls -lh "$file" 2>/dev/null || echo "  $file"
        done
    fi
    
    # Show quick summary of open ports
    echo ""
    echo "=== Open Ports Summary ==="
    for scan_type in "${scan_array[@]}"; do
        local scan_file="${scan_type}-all-${target_clean}.nmap"
        if [[ -f "$scan_file" ]]; then
            local open_count=$(grep -c '^[0-9]\+/.*open' "$scan_file" 2>/dev/null || echo "0")
            # Use :u for uppercase in zsh instead of ^^
            echo "${scan_type:u}: $open_count open ports"
        fi
    done
    
    # Show service detection summary
    if [[ "$run_service_scan" = true ]]; then
        echo ""
        echo "=== Service Detection Results ==="
        for scan_type in "${scan_array[@]}"; do
            local svc_file="${scan_type}-svc-${target_clean}.nmap"
            if [[ -f "$svc_file" ]]; then
                echo "${scan_type:u} services in: ${scan_type}-svc-${target_clean}.nmap"
            fi
        done
        
        if [[ "$generate_html" = true && -f "targeted-${target_clean}.html" ]]; then
            echo "Consolidated HTML report: targeted-${target_clean}.html"
        fi
    fi
}
